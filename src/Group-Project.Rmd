---
title: "GROUP PROJECT CSC 3220 - Real Estate Data"
author: |
  | Robert Bingham
  | Phonethep Nakhonekhong
  | Eli Parker
  | John Taylor
  | Johnathan Rich
date: "2022-11-08"
output:
  html_document:
    df_print: paged
header-includes: \usepackage{fvextra} \DefineVerbatimEnvironment{Highlighting}{Verbatim}{breaklines,commandchars=\\\{\}}
---

## Introduction

Our group, 5 little minds, have decided to look at real estate market data from 2012 to 2021 in order to predict future trends in the next 5 years. This data includes median list price for a given neighborhood in each state; median prices based upon housing unit categories, such as apartments, single-family housing, and condos; and year-to-year increases in sale prices of each unit.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, fig.align = 'center')
```

### Import the necessary libraries
```{r, warning = FALSE, message = FALSE}
library("ggplot2")
library("DT")
library("pander")
library("corrplot")
library("zoo")
library("reshape")
library("scales")
```

### Import the Data

We decided to use the data from this url from Kaggle for our dataset:

[kaggle](https://www.kaggle.com/datasets/thuynyle/redfin-housing-market-data?select=state_market_tracker.tsv000)

```{r}
state_market.df <- read.table("../data/state_market_tracker.tsv000", sep = '\t', header = TRUE)
```   

### Data Manipulation

Here, we have made R recognize the variables in the dataset that pertain to specific days, (i.e, 9/21/2022) as actual dates using the built-in as.Date function. We have also divided the median sale price and list price of homes in each neighborhood by 1000 in order to  make the data more readable in subsequent graphs.

```{r}
state_market.df$period_begin <- as.Date(state_market.df$period_begin)
state_market.df$period_end <- as.Date(state_market.df$period_end)
state_market.df$median_sale_price <- state_market.df$median_sale_price / 1000
state_market.df$median_list_price <- state_market.df$median_list_price / 1000
state_market.df$property_type[state_market.df$property_type == "Multi-Family (2-4 Unit)"] <- "Multi-Family"
```

Here, we created a boxplot graph for the median list price of the homes in each neighborhood in the dataset, with each boxplot representing . Hawaii and and Connecticut were had the highest number of outliers. Since there were more outliers above the boxplot than below it in both cases, we attributed these anomalies to the high cost of living in both states, Since Hawaii is a vacation destination and Connecticut is a New England state with a close proximity to New York City.

```{r, fig.width = 12, fig.height = 10}
split_by_year <- split(state_market.df, format(state_market.df$period_begin, "%Y"))

ggplot(split_by_year[[length(split_by_year)]], aes(x = state_code, y = median_sale_price, color=median_sale_price)) +
  geom_boxplot(colour="#003366", fill="#66FFFF", alpha=5) +
  geom_point() +
  xlab("2021") +
  ylab("Median Sales Price (in thousands)") +
  ggtitle("Distribution of Median Sale Price per State") +
  theme(plot.title = element_text(hjust = 0.5))
```

\newpage

We created 2 histograms. One is for the median list price of housing units in each of the 27,054 neighborhoods from 2012 to 2021. The other is the median sale price of  over the same length of time. We not

```{r}
mean_years <- data.frame(state_market.df$period_begin, state_market.df$median_sale_price_yoy, state_market.df$state)
new_df <- subset.data.frame(state_market.df, select = c(state_code, median_list_price, median_sale_price),  drop = FALSE)
print(
    ggplot(new_df, aes_string(x=new_df$median_list_price))
    + geom_histogram(
      colour="darkorchid4", fill="darkorchid1", position="identity", bins=30, alpha=0.2
    )
    + ggtitle(paste("Frequency Distribution of Median List Price", sep=""))
    + theme(plot.title=element_text(hjust = 0.5))
    + xlab("Median List Price of Each Neighboorhood")
    + ylab("Frequency of Neighborhoods")
    + ylim(0, 12500))
```



```{r}
print(
    ggplot(new_df, aes_string(x=new_df$median_sale_price))
    + geom_histogram(
      colour="red", fill="firebrick1", position="identity", bins=30, alpha=0.2
    )
    + ggtitle(paste("Frequency Distribution of Median Sale Price", sep=""))
    + theme(plot.title=element_text(hjust = 0.5))
    + xlab("Median Sale Price of Each Neighboorhood")
    + ylab("Frequency of Neighborhoods")
    + ylim(0, 12500))
```

```{r}
cor.df <- subset.data.frame(state_market.df, select = c(median_sale_price, median_list_price, median_sale_price_yoy, median_list_price_yoy, median_ppsf, median_list_ppsf, homes_sold_yoy, pending_sales_yoy, new_listings_yoy, inventory_yoy),  drop = FALSE)

cor.table <- cor(cor.df, use="pairwise.complete.obs")

corrplot(cor.table)
```

We can create a bin plot to demonstrate that home sale prices tend to aggregate below a million, between 100 thousand to 300 thousand. We have fitted a best fit line to show that there is a positive increase in median sales price over time, however, with a r-squared value of 0.125, only 12.5% of this increase can be explained by time. This is understandable, since the value of a home includes many factors such as: location, land, size, time built, etc.

```{r, fig.width = 12, fig.height = 10}
lm_eqn <- function(df){
    m <- lm(median_sale_price ~ as.yearmon(period_begin), df);
    eq <- substitute(italic(median_sale_price) == b %.% italic(period_begin) + a*","~~italic(r)^2~"="~r2, 
         list(a = format(unname(coef(m)[1]), digits = 2),
              b = format(unname(coef(m)[2]), digits = 2),
             r2 = format(summary(m)$r.squared, digits = 3)))
    as.character(as.expression(eq));
}

ggplot(state_market.df, aes(x = as.yearmon(period_begin), y = median_sale_price)) +
  geom_bin_2d(binwidth = c(1/12, 10)) +
  xlab("Time") +
  ylab("Median Sales Price (in thousands)") +
  ggtitle("Median Sales Price over Time") +
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_x_yearmon(n = 10) +
  geom_smooth(method = "lm", se = FALSE, color = "red") +
  annotate("text", x = as.numeric(as.yearmon("2014-06-01")), y = 3000, parse = TRUE, label = lm_eqn(state_market.df))
```

#### Both townhouse and multi-family have extreme outliers in the median sales price.

```{r}
ggplot(state_market.df, aes(x = property_type, y = median_sale_price)) +
  geom_boxplot(colour="#003366", fill="#66FFFF", alpha=1/2) +
  xlab("Property Type") +
  ylab("Median Sales Price (in thousands)") +
  ggtitle("Property Type vs Median Sales Price") +
  theme(plot.title = element_text(hjust = 0.5))
```

```{r, echo = FALSE}
property_type_outlier_table <- function(df, type, sale_price = TRUE){
  data <- with(df, df[property_type == type, ])
  
  if(sale_price){
    upper_bound <- quantile(data$median_sale_price, 0.99, na.rm = TRUE)
    outlier_indices <- which(data$median_sale_price > upper_bound)
  }
  else{
    upper_bound <- quantile(data$median_list_price, 0.99, na.rm = TRUE)
    outlier_indices <- which(data$median_list_price > upper_bound)
  }
  
  print(table(data$region[outlier_indices]))
}

cat("For our outlier tests, we will test if anything is above the 99th quantile. We can see that for the outliers for multi-family housing the state Hawaii has the most outliers. This gives us a good explanation in the reason for the outliers, since Hawaii is a small state in the middle of the Pacific serverely limiting the supply of land.")
property_type_outlier_table(state_market.df, type = "Multi-Family")

cat("The same thing is repeated with townhouses, but Connecticut has almost as many as Hawaii now. There is a possibility that the reasoning behind this is the same as Hawaii with the limited supply of land, but it also could be that mostly everywhere in Connecticut is close to a town or city that sports many amenities.")
property_type_outlier_table(state_market.df, type = "Townhouse")
```

#### The extreme outliers are not as pronounced with the median list price.

```{r}
ggplot(state_market.df, aes(x = property_type, y = median_list_price)) +
  geom_boxplot(colour="#003366", fill="#66FFFF", alpha=1/2) +
  xlab("Property Type") +
  ylab("Median Sales Price (in thousands)") +
  ggtitle("Property Type vs Median List Price") +
  theme(plot.title = element_text(hjust = 0.5))
```

```{r, echo = FALSE}
cat("California leads the US in most outliers for all residential house prices while Columbia and Hawaii are not far behind. Hawaii has the same reasoning for the listing price as what was explained above. California's outliers can be explained by the housing markets predictions that a huge demand for housing will always be present in the state. Columbia?")
property_type_outlier_table(state_market.df, type = "All Residential", sale_price = FALSE)

cat("New York leads the US in most outliers for condo/co-op house prices. New York will obviously lead in most outliers, since most people only live in condo's or cooperative housing in the state and the housing markets prediction of ever increasing demands of housing in places like New York City.")
property_type_outlier_table(state_market.df, type = "Condo/Co-op", sale_price = FALSE)

cat("California and Columbia leads the US in most outliers for single residential house prices. California is the same as described above. Columbia?")
property_type_outlier_table(state_market.df, type = "Single Family Residential", sale_price = FALSE)
```
